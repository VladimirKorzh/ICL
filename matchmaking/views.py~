
from django.shortcuts import render, redirect

from django.contrib.auth.decorators import login_required
from django.contrib.auth import logout

from django.conf import settings
from matchmaking.models import Lobby, Player, Search


import mm, icl

def landing(request):
    if not request.user.is_authenticated():
	return redirect('/intro')
    else:
	return redirect('/profile')

def intro(request):
	server = icl.connect2server()
	users = server.getUsers()
	userlist = [users[i] for i in users]
	usernum = len(userlist)
		
	return render(request, 'matchmaking/intro.html', 
		      {'usernum':usernum, 'userlist':userlist, 'requestuser':request.user})  
@login_required
def profile(request):
	steam_api_key = settings.STEAM_API_KEY
	social_auth = request.user.social_auth.get(provider='steam')
	
	data = {'username':request.user, 'apikey': steam_api_key, 'steamid':social_auth.extra_data.get('steamid'), 'avatar':mm.getUserAvatarUrl(request)}
	
	server = icl.connect2server()
  
	allseaching = Search.objects.all()  
	alllobbys   = Lobby.objects.all()
	
	# get all lobbys that are not full
	data['openlobbys'] = []
	for lobby_obj in alllobbys:
	  if Player.objects.filter(lobby=lobby_obj).count() < 5:
	    lobbyinfo = {'name':          lobby_obj.name,
			'players_count': Player.objects.filter(lobby=lobby_obj).count(),
			'players_list':  Player.objects.filter(lobby=lobby_obj).values('nickname')}
	    data['openlobbys'].append(lobbyinfo)

	mm.updateUserInfo(request)
	return render(request, 'matchmaking/profile.html', data)

